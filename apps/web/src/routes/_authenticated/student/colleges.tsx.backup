import { createFileRoute } from "@tanstack/react-router";
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { orpc } from "orpc/client";
import { MagnifyingGlass, FunnelSimple, MapPin, GraduationCap } from "@phosphor-icons/react";

export const Route = createFileRoute("/_authenticated/student/colleges")({
  component: CollegesPage,
});

type Country = "US" | "UK";

function CollegesPage() {
  const [selectedCountry, setSelectedCountry] = useState<Country>("US");
  const [searchQuery, setSearchQuery] = useState("");
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState({
    states: [] as string[],
    locations: [] as string[],
    maxTuition: undefined as number | undefined,
    minAdmissionRate: undefined as number | undefined,
    maxAdmissionRate: undefined as number | undefined,
    minSATScore: undefined as number | undefined,
    maxSATScore: undefined as number | undefined,
    campusSetting: [] as string[],
    citySize: [] as string[],
  });

  // Fetch US colleges
  const usCollegesQuery = useQuery({
    ...orpc.college.searchUS.queryOptions({
      input: {
        search: searchQuery || undefined,
        states: filters.states.length > 0 ? filters.states : undefined,
        maxTuition: filters.maxTuition,
        minAdmissionRate: filters.minAdmissionRate,
        maxAdmissionRate: filters.maxAdmissionRate,
        minSATScore: filters.minSATScore,
        maxSATScore: filters.maxSATScore,
        campusSetting:
          filters.campusSetting.length > 0 ? filters.campusSetting : undefined,
        sortBy: "name",
        limit: 50,
      },
    }),
    enabled: selectedCountry === "US",
  });

  // Fetch UK colleges
  const ukCollegesQuery = useQuery({
    ...orpc.college.searchUK.queryOptions({
      input: {
        search: searchQuery || undefined,
        locations: filters.locations.length > 0 ? filters.locations : undefined,
        maxTuition: filters.maxTuition,
        citySize: filters.citySize.length > 0 ? filters.citySize : undefined,
        sortBy: "name",
        limit: 50,
      },
    }),
    enabled: selectedCountry === "UK",
  });

  // Fetch filter options
  const filterOptionsQuery = useQuery(
    orpc.college.getFilterOptions.queryOptions({ input: {} })
  );

  const colleges =
    selectedCountry === "US"
      ? usCollegesQuery.data?.colleges || []
      : ukCollegesQuery.data?.colleges || [];

  const isLoading =
    selectedCountry === "US" ? usCollegesQuery.isLoading : ukCollegesQuery.isLoading;

  return (
    <div className="h-full flex flex-col bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 px-6 py-6">
        <div className="max-w-7xl mx-auto">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            University Explorer
          </h1>
          <p className="text-gray-600">
            Discover and research universities in the US and UK
          </p>
        </div>
      </div>

      {/* Country Selector */}
      <div className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="max-w-7xl mx-auto flex gap-4">
          <button
            onClick={() => setSelectedCountry("US")}
            className={`px-6 py-2 rounded-lg font-medium transition-colors ${
              selectedCountry === "US"
                ? "bg-blue-600 text-white"
                : "bg-gray-100 text-gray-700 hover:bg-gray-200"
            }`}
          >
            United States
          </button>
          <button
            onClick={() => setSelectedCountry("UK")}
            className={`px-6 py-2 rounded-lg font-medium transition-colors ${
              selectedCountry === "UK"
                ? "bg-blue-600 text-white"
                : "bg-gray-100 text-gray-700 hover:bg-gray-200"
            }`}
          >
            United Kingdom
          </button>
        </div>
      </div>

      {/* Search and Filters Bar */}
      <div className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="max-w-7xl mx-auto flex gap-4">
          {/* Search Bar */}
          <div className="flex-1 relative">
            <MagnifyingGlass
              className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
              size={20}
            />
            <input
              type="text"
              placeholder="Search universities by name or location..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* Filter Button */}
          <button
            onClick={() => setShowFilters(!showFilters)}
            className="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            <FunnelSimple size={20} />
            <span>Filters</span>
          </button>
        </div>

        {/* Filters Panel */}
        {showFilters && (
          <div className="max-w-7xl mx-auto mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {selectedCountry === "US" ? (
                <>
                  {/* US Filters */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Max Tuition (Out-of-State)
                    </label>
                    <input
                      type="number"
                      placeholder="e.g., 50000"
                      value={filters.maxTuition || ""}
                      onChange={(e) =>
                        setFilters({
                          ...filters,
                          maxTuition: e.target.value
                            ? Number(e.target.value)
                            : undefined,
                        })
                      }
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Admission Rate Range
                    </label>
                    <div className="flex gap-2">
                      <input
                        type="number"
                        placeholder="Min %"
                        min="0"
                        max="100"
                        value={
                          filters.minAdmissionRate
                            ? filters.minAdmissionRate * 100
                            : ""
                        }
                        onChange={(e) =>
                          setFilters({
                            ...filters,
                            minAdmissionRate: e.target.value
                              ? Number(e.target.value) / 100
                              : undefined,
                          })
                        }
                        className="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="number"
                        placeholder="Max %"
                        min="0"
                        max="100"
                        value={
                          filters.maxAdmissionRate
                            ? filters.maxAdmissionRate * 100
                            : ""
                        }
                        onChange={(e) =>
                          setFilters({
                            ...filters,
                            maxAdmissionRate: e.target.value
                              ? Number(e.target.value) / 100
                              : undefined,
                          })
                        }
                        className="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      SAT Score Range
                    </label>
                    <div className="flex gap-2">
                      <input
                        type="number"
                        placeholder="Min"
                        min="400"
                        max="1600"
                        value={filters.minSATScore || ""}
                        onChange={(e) =>
                          setFilters({
                            ...filters,
                            minSATScore: e.target.value
                              ? Number(e.target.value)
                              : undefined,
                          })
                        }
                        className="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                      <input
                        type="number"
                        placeholder="Max"
                        min="400"
                        max="1600"
                        value={filters.maxSATScore || ""}
                        onChange={(e) =>
                          setFilters({
                            ...filters,
                            maxSATScore: e.target.value
                              ? Number(e.target.value)
                              : undefined,
                          })
                        }
                        className="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  </div>
                </>
              ) : (
                <>
                  {/* UK Filters */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Max Tuition Fees
                    </label>
                    <input
                      type="number"
                      placeholder="e.g., 50000"
                      value={filters.maxTuition || ""}
                      onChange={(e) =>
                        setFilters({
                          ...filters,
                          maxTuition: e.target.value
                            ? Number(e.target.value)
                            : undefined,
                        })
                      }
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                </>
              )}

              <div className="flex items-end">
                <button
                  onClick={() =>
                    setFilters({
                      states: [],
                      locations: [],
                      maxTuition: undefined,
                      minAdmissionRate: undefined,
                      maxAdmissionRate: undefined,
                      minSATScore: undefined,
                      maxSATScore: undefined,
                      campusSetting: [],
                      citySize: [],
                    })
                  }
                  className="px-4 py-2 text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  Clear All Filters
                </button>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Results */}
      <div className="flex-1 overflow-auto px-6 py-6">
        <div className="max-w-7xl mx-auto">
          {isLoading ? (
            <div className="flex items-center justify-center h-64">
              <div className="text-gray-500">Loading universities...</div>
            </div>
          ) : colleges.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-64 text-gray-500">
              <GraduationCap size={48} className="mb-4 text-gray-400" />
              <p>No universities found matching your criteria</p>
              <p className="text-sm mt-2">Try adjusting your filters</p>
            </div>
          ) : (
            <>
              <div className="mb-4 text-sm text-gray-600">
                Showing {colleges.length} of{" "}
                {selectedCountry === "US"
                  ? usCollegesQuery.data?.total
                  : ukCollegesQuery.data?.total}{" "}
                universities
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {colleges.map((college: any) => (
                  <CollegeCard
                    key={college.id}
                    college={college}
                    country={selectedCountry}
                  />
                ))}
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

interface CollegeCardProps {
  college: any;
  country: Country;
}

function CollegeCard({ college, country }: CollegeCardProps) {
  const name =
    country === "US" ? college.schoolName : college.universityName;
  const location =
    country === "US"
      ? `${college.schoolCity}, ${college.schoolState}`
      : college.location;
  const tuition =
    country === "US"
      ? college.tuitionOutOfState
      : college.tuitionFees;

  return (
    <a
      href={`/student/colleges/${country.toLowerCase()}/${college.id}`}
      className="block bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow overflow-hidden"
    >
      {/* Image */}
      {college.imageUrl && (
        <div className="h-48 overflow-hidden bg-gray-100">
          <img
            src={college.imageUrl}
            alt={name}
            className="w-full h-full object-cover"
          />
        </div>
      )}

      {/* Content */}
      <div className="p-4">
        <h3 className="font-semibold text-lg text-gray-900 mb-2 line-clamp-2">
          {name}
        </h3>

        <div className="flex items-center gap-2 text-sm text-gray-600 mb-3">
          <MapPin size={16} className="text-gray-400" />
          <span>{location}</span>
        </div>

        <div className="space-y-2">
          {tuition && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Tuition:</span>
              <span className="font-medium text-gray-900">
                ${Number(tuition).toLocaleString()}
              </span>
            </div>
          )}

          {country === "US" && college.admissionRate && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Acceptance Rate:</span>
              <span className="font-medium text-gray-900">
                {(college.admissionRate * 100).toFixed(1)}%
              </span>
            </div>
          )}

          {country === "US" && college.satScoreAverage && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Avg SAT:</span>
              <span className="font-medium text-gray-900">
                {college.satScoreAverage}
              </span>
            </div>
          )}

          {country === "US" && college.usNewsNationalRanking && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">US News Rank:</span>
              <span className="font-medium text-gray-900">
                #{college.usNewsNationalRanking}
              </span>
            </div>
          )}
        </div>

        <div className="mt-4 pt-4 border-t border-gray-100">
          <span className="text-sm text-blue-600 hover:text-blue-700 font-medium">
            View Details â†’
          </span>
        </div>
      </div>
    </a>
  );
}
